# S3 Migration for YouTube Videos

This document describes the changes made to migrate YouTube video storage from local files to Amazon S3.

## Overview

Previously, YouTube videos were downloaded and stored locally in the `videos/` folder. Now, videos are automatically uploaded to S3 after download and the local files are deleted to save disk space. Additionally, thumbnails and formatted transcripts are also uploaded to S3 and stored with their respective keys in the database.

## Changes Made

### 1. Modified `download_video_background` Function

**File**: `youtube_backend.py`

The background download function now:
- Downloads the video locally first
- Uploads it to S3 with the key format: `youtube_videos/{video_id}.mp4`
- Generates and uploads thumbnail to S3 with key format: `youtube_thumbnails/{video_id}.jpg`
- Updates the database with both S3 keys and clears the local path
- Deletes the local files after successful S3 upload
- Falls back to local storage if S3 upload fails

### 2. Updated `get_downloaded_video_path` Function

**File**: `youtube_backend.py`

This function now:
- Checks if the video has an S3 key
- Returns a presigned S3 URL if available
- Falls back to local file path if S3 is not configured
- Handles both local and cloud storage seamlessly

### 3. Enhanced Video Serving Endpoint

**File**: `youtube_backend.py`

The `/api/videos/{video_id}` endpoint now:
- Redirects to S3 presigned URLs for cloud-stored videos
- Serves local files for locally-stored videos
- Provides seamless access regardless of storage location

### 4. Enhanced Transcript Formatting

**File**: `youtube_backend.py`

The transcript formatting functions now:
- Upload formatted transcripts to S3 with key format: `youtube_transcripts/{video_id}_formatted.txt`
- Store transcript S3 keys in the database
- Clean up temporary local files after S3 upload
- Handle both YouTube and uploaded video transcripts

### 5. Added Migration Utilities

**Files**: `youtube_backend.py`

New functions added:
- `migrate_local_videos_to_s3()`: Migrates existing local videos, thumbnails, and transcripts to S3
- `cleanup_local_videos()`: Cleans up local files that have been uploaded to S3

### 6. New Admin Endpoints

**File**: `youtube_backend.py`

Added endpoints for administration:
- `POST /api/admin/migrate-local-videos-to-s3`: Migrate existing videos, thumbnails, and transcripts to S3
- `POST /api/admin/cleanup-local-videos`: Clean up local files

## Configuration

### Required Environment Variables

Make sure these are set in your `.env` file:

```bash
AWS_S3_BUCKET=your_s3_bucket_name
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_S3_REGION=us-east-1  # or your preferred region
```

### Optional Environment Variables

```bash
AWS_S3_ENDPOINT=your_custom_endpoint  # for non-AWS S3-compatible storage
```

## Database Schema

The existing `Video` model already supports this change:

- `s3_key`: Stores the S3 object key for the video
- `thumb_key`: Stores the S3 object key for the thumbnail
- `transcript_s3_key`: Stores the S3 object key for the formatted transcript
- `download_path`: Stores the local file path (cleared after S3 upload)

## Usage

### For New Videos

When a YouTube video is processed via `/api/youtube/info`:
1. Video is downloaded locally
2. Thumbnail is generated from the video
3. Video and thumbnail are uploaded to S3
4. Local files are deleted
5. Database is updated with S3 keys
6. Formatted transcript is uploaded to S3 when available

### For Existing Videos

To migrate existing local videos to S3:

```bash
# Call the migration endpoint
curl -X POST http://your-api-url/api/admin/migrate-local-videos-to-s3

# Clean up any remaining local files
curl -X POST http://your-api-url/api/admin/cleanup-local-videos
```

### Video Access

Videos can be accessed via:
- `/api/videos/{video_id}` - Automatically redirects to S3 or serves locally
- Direct S3 presigned URLs (generated by `get_downloaded_video_path`)
- Thumbnails and formatted transcripts are also available via S3 presigned URLs

## Testing

Use the provided test script:

```bash
python test_s3_migration.py
```

This script tests:
- S3 configuration
- Migration endpoints
- YouTube download with S3 upload
- Cleanup functionality

## Benefits

1. **Disk Space**: Local storage is freed up after S3 upload (videos, thumbnails, and transcripts)
2. **Scalability**: All media files are stored in the cloud, not on the server
3. **Reliability**: S3 provides better durability than local storage
4. **Performance**: Presigned URLs allow direct access to S3 for all file types
5. **Backward Compatibility**: Falls back to local storage if S3 is not configured
6. **No Local File Dependencies**: No reliance on `formatted_transcript.txt` or other local files

## Error Handling

The system gracefully handles:
- S3 upload failures (keeps local file)
- Missing S3 configuration (uses local storage)
- Network issues during upload
- Database update failures

## Monitoring

Check the application logs for:
- S3 upload success/failure messages
- Migration progress
- Cleanup operations
- Error details for troubleshooting

## Rollback

If you need to rollback to local-only storage:
1. Stop the application
2. Set `AWS_S3_BUCKET=""` in your environment
3. Restart the application
4. Videos will be stored locally only

## Security Considerations

- S3 presigned URLs expire after 1 hour by default
- Videos are stored with private ACL
- Access is controlled through the API endpoints
- No direct S3 access is exposed to clients
